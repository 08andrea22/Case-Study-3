---
title: "JK Working"
author: "Jennifer Kampe"
date: "3/2/2021"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyr)
library(dplyr)
library(ggplot2)
library(reshape2)
```

Load the data
```{r}
load("cardiomort.RData")
load("amy.rdata")
```

Check out some variables, expected mortality is the Hospital Compare metric?
```{r}
all.equal(cardio$`Expected Mortality Rate`, 
          cardio$`Observed Deaths`/cardio$`Total Procedures`)
```

Data cleaning
```{r}
df = cardio %>%
  group_by(`Hospital Name`) %>%
  summarize(volume = max(`Total Procedures`), overall_deaths = max(`Observed Deaths`)) %>%
  right_join(cardio) %>%
  mutate(category = sub("STAT Mortality ", "", `Procedure Type`)) %>%
  select(-`Procedure Type`) %>%
  mutate(mort_rate = `Observed Deaths` / `Total Procedures`, 
         mort_rate_overall = overall_deaths/volume) %>%
  #filter(procedure!="Overall") %>%
  rename(hospital = `Hospital Name`, deaths = `Observed Deaths`, 
         procedures = `Total Procedures`, EMR = `Expected Mortality Rate`) %>%
  mutate(id = as.numeric(id)) %>%
  mutate(category = as.factor(category)) %>%
  as.data.frame()
  

# Plot fatality rate versus total volume by category
df %>% filter(procedure !="Category 5") %>%
  ggplot(aes(x=volume, y=mort_rate)) + 
  geom_point() + 
  facet_wrap(~ procedure, scales="free_y")

df %>% 
  ggplot(aes(x=procedures, y=mort_rate)) + 
  geom_point()  + 
  facet_wrap(~ category, scales="free")
```

Andrea's mortality rate by procedure plot
```{r}
dt=df%>%
  group_by(category)%>%
  summarize(deaths=sum(deaths), tot=sum(procedures))%>%
  mutate(fatality=deaths/tot) %>%
  select(category, fatality, ) %>%
  filter(category !="Overall")

dt %>%
  ggplot(aes(x=category, y=fatality))+
  geom_col() 


```

Add hospital covariates
```{r, eval=FALSE}
hos=data.frame(hospital = unique(cardio$`Hospital Name`), teaching = NA, trauma_level = NA, helipad=NA, ped_trauma_level = NA, nbeds = NA, npediatricbeds=NA, nbassinets=NA, rural = NA, nicu = NA, nicu_level = NA, top50_ped_anyspecialty= NA, top50_ped_cardio = NA, rank_ped_cardio = NA, top50_ped_pulm = NA, rank_ped_pulm = NA)

write.csv(hos, "hospital_covariates.csv", row.names=FALSE)
```

Combine hospital covariates and Dunson's data
```{r}
# Drop overall category
df1 <- filter(df,category!="Overall")

# Add procedures , proportions by hospital
cats <- dcast(melt(df1[, c(1,6,8)]), hospital  ~ category + variable)
df1 <- inner_join(df1, cats)

df1 <- df1 %>% rename(cat1 = `Category 1_procedures`, cat2 = `Category 2_procedures`, 
               cat3 = `Category 3_procedures`, cat4 = `Category 4_procedures`, 
               cat5 = `Category 5_procedures`, total_procedures = volume) %>%
      mutate(prop_5 = cat5/total_procedures, prop_4 = cat4/total_procedures, 
              prop_45 = (cat4 + cat5)/ total_procedures) %>%
      select(hospital, id, category, procedures, deaths, mort_rate, mort_rate_overall, EMR, everything()) 

hosp <- read.csv("hosp.csv", header=TRUE)
hosp <- hosp %>% select(-c(deaths, procedures, EMR, hospital))
hosp_full <- left_join(df1, hosp, by = "id") 
write.csv(hosp_full, "hosp_full.csv", row.names=FALSE)
      
                
```

EDA

```{r}
# cardiology rank

ggplot(hosp, aes(x = as.factor(top50_ped_cardio), y = deaths, fill = as.factor(top50_ped_cardio))) + geom_boxplot() + 
  labs(title = "Procedures Compared to Ranking Indicator for Cardiology", fill = "Ranked in Top 50 for Cardiology") + scale_fill_discrete(labels = c("No", "Yes")) + ylab("Deaths") + xlab("Ranked Indicator")

# Mortality rate versus proportion of category five procedures



 df1 %>% group_by(hospital)%>%
  summarize(total_cat45=sum(deaths), tot=sum(procedures))%>%
  mutate(fatality=deaths/tot) %>%
  select(category, fatality, ) %>%
  filter(category !="Overall")



```

