---
title: "JK Working"
author: "Jennifer Kampe"
date: "3/2/2021"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyr)
library(dplyr)
library(ggplot2)
```

Load the data
```{r}
load("cardiomort.RData")
load("amy.rdata")
```

Check out some variables, expected mortality is the Hospital Compare metric?
```{r}
all.equal(cardio$`Expected Mortality Rate`, 
          cardio$`Observed Deaths`/cardio$`Total Procedures`)
```

Data cleaning
```{r}
df = cardio %>%
  group_by(`Hospital Name`) %>%
  summarize(volume = max(`Total Procedures`)) %>%
  right_join(cardio) %>%
  mutate(category = sub("STAT Mortality ", "", `Procedure Type`)) %>%
  select(-`Procedure Type`) %>%
  mutate(mort_rate = `Observed Deaths` / `Total Procedures`) %>%
  #filter(procedure!="Overall") %>%
  rename(hospital = `Hospital Name`, deaths = `Observed Deaths`, 
         procedures = `Total Procedures`, EMR = `Expected Mortality Rate`) %>%
  mutate(id = as.numeric(id)) %>%
  mutate(category = as.factor(category)) %>%
  as.data.frame()
  

# Plot fatality rate versus total volume by category
df %>% filter(procedure !="Category 5") %>%
  ggplot(aes(x=volume, y=mort_rate)) + 
  geom_point() + 
  facet_wrap(~ procedure, scales="free_y")

df %>% 
  ggplot(aes(x=procedures, y=mort_rate)) + 
  geom_point()  + 
  facet_wrap(~ category, scales="free")
```

Andrea's mortality rate by procedure plot
```{r}
dt=df%>%
  group_by(procedure)%>%
  summarize(deaths=sum(`Observed Deaths`), tot=sum(`Total Procedures`))%>%
  mutate(fatality=deaths/tot) %>%
  select(procedure, fatality, ) %>%
  filter(procedure !="Overall")

dt %>%
  ggplot(aes(x=procedure, y=fatality))+
  geom_col() 


```

Add hospital covariates
```{r, eval=FALSE}
hos=data.frame(hospital = unique(cardio$`Hospital Name`), teaching = NA, trauma_level = NA, helipad=NA, ped_trauma_level = NA, nbeds = NA, npediatricbeds=NA, nbassinets=NA, rural = NA, nicu = NA, nicu_level = NA, top50_ped_anyspecialty= NA, top50_ped_cardio = NA, rank_ped_cardio = NA, top50_ped_pulm = NA, rank_ped_pulm = NA)

write.csv(hos, "hospital_covariates.csv", row.names=FALSE)
```

Combine hospital covariates and Dunson's data
```{r}
# Drop overall category
df1 <- filter(df,category!="Overall")
hosp <- read.csv("hosp.csv", header=TRUE)
hosp <- hosp %>% select(-c(deaths, procedures, EMR, hospital))
hosp_full <- left_join(df1, hosp, by = "id") 
write.csv(hosp_full, "hosp_full.csv", row.names=FALSE)
```



