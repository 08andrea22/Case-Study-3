---
title: "alexwork"
author: "Alex Dombowsky"
date: "3/2/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(ggplot2)
library(grid)
library(gridExtra)
library(tibble)
library(rstanarm)
library(latex2exp)
library(tidyr)

```

# data

```{r}
load("cardiomort.RData")
```


# subsetting into overall and categories

```{r}
# cardio data
cardio_ov <- cardio[cardio$`Procedure Type` == "Overall", ]
cardio_cat <- cardio[cardio$`Procedure Type` != "Overall", ]

colnames(cardio_cat) <- c("id", "name", "category", "deaths", "procedures", "EMR")
cardio_cat$category <- as.factor(cardio_cat$category)
cardio_cat$category <- recode(cardio_cat$category,
       "STAT Mortality Category 1" = 1,
       "STAT Mortality Category 2" = 2,
       "STAT Mortality Category 3" = 3,
       "STAT Mortality Category 4" = 4,
       "STAT Mortality Category 5" = 5)
cardio_cat$category <- as.factor(cardio_cat$category)

# hospital covariates
hosp <- read.csv("hosp.csv")
```


# Basic Facts

```{r}
length(levels(as.factor(cardio$`Hospital Name`)))

```
There are 82 hospitals, scattered seemingly across the US.

# Contingency Tables
```{r}
procedures <- aggregate(cardio_cat$procedures, by = list(Category = cardio_cat$category), FUN = sum)
colnames(procedures) <- c("Category", "Procedures")
procedures
```

In the whole data, we see that the ranking of number of procedures for each category is 2, 1, 4, 3, 5.

```{r}
deaths <- aggregate(cardio_cat$deaths, by = list(Category = cardio_cat$category), FUN = sum)
colnames(deaths) <- c("Category", "Deaths")
deaths
```


In the whole data, we see that the ranking of number of deaths for each category is 4, 5, 2, 3, 1. 

# Summary Statistics of Volume

```{r}
quantile(cardio_ov$`Total Procedures`, c(0.025, 0.5, 0.975))
```
The median number of procedures is 761. 

```{r}
ggplot(data.frame("Procedures" = cardio_ov$`Total Procedures`), aes(x = Procedures)) + geom_histogram()
```
We can see that most hospitals have fewer than 2,000 cases, though some have above that. The distribution of the procedures is multimodal and right skewed, with the largest mode occurring between 500 and 1,000 procedures.

# Summary Statistics of Death

```{r}
quantile(cardio_ov$`Observed Deaths`, c(0.025, 0.5, 0.975))
```
The median number of deaths is 20. 

```{r}
ggplot(data.frame("Deaths" = cardio_ov$`Observed Deaths`), aes(x = Deaths)) + geom_histogram()
```
Similarly, the distribution of deaths is right skwed, with multiple modes in between - and 45 deaths.

# Summary Statistics of Volume and Deaths

```{r}
ggplot(data = cardio_ov, aes(x = `Total Procedures`, y = `Observed Deaths`)) + geom_point()
```
In the aggregated data, it does seem that the total number of procedures is positively correlated with the number of deaths (makes sense).

Let's replicate the same graph from the paper.

```{r}
cardio_ov$mort_rate <- cardio_ov$`Observed Deaths`/cardio_ov$`Total Procedures`

ggplot(data = cardio_ov, aes(x = `Total Procedures`, y = mort_rate)) + geom_point()
```
Similar to the paper, the variation in $\mathcal{O}_h$ is highest at hospitals with fewer total procedures. However, we don't quite see the same dramatic decrease they have in the paper (probably because we're focusing on different conditions). 

# Similar Statistcs by Category


```{r}
ggplot(cardio_cat, aes(x = procedures, y = deaths, color = category)) + geom_point()
```
And from this we can see which are the most deadly categories. 

```{r}
cardio_cat$mort_rate <- cardio_cat$deaths/cardio_cat$procedures

ggplot(data = cardio_ov, aes(x = `Total Procedures`, y = mort_rate)) + geom_point()
```
```{r}
plots <- list()
for (j in 1:5) {
  plots[[j]] <- ggplot(data = cardio_cat[cardio_cat$category == toString(j), ], aes(x = procedures, y = mort_rate)) + geom_point() + labs(title = paste("Category", toString(j)))
}

grid.arrange(plots[[1]], plots[[2]], plots[[3]], plots[[4]], plots[[5]], widths = c(1,1), layout_matrix = rbind(c(1,2), c(3,4), c(5,5)))

```
# Adding to Hospital Covariates

```{r}
hosp_ad <- read.csv("hospital_covariates.csv")
hosp_jk <- read.csv("hospital_covariates_jk.csv")
hosp <- rbind(hosp_jk[1:41, colnames(hosp_ad)], hosp_ad[42:82, ])
hosp <- add_column(hosp, ped_trauma = c(hosp_jk[1:41, "ped_trauma"], rep(1, 41)), .after = "helipad")
write.csv(hosp, "hosp.csv", row.names = F)

# rewriting hosp
hosp <- read.csv("hosp.csv")
hosp_ad <- read.csv("hospital_covariates.csv")
hosp_ad <- hosp_ad[42:82, ]
names <- hosp_ad$hospital != "University Hospital" & hosp_ad$hospital != "Mount Sinai Hospital"
names <- names[-length(names)]
hosp_red <- hosp[42:82, ]
hosp_red[names, ] <- hosp_ad[names, ]
hosp[42:82, ] <- hosp_red
write.csv(hosp, "hosp.csv", row.names = F)

# changing NAs in rankings
hosp <- hosp %>% replace_na(list("top50_ped_anyspecialty" = 0, "top50_ped_cardio" = 0, "top50_ped_pulm" = 0))
write.csv(hosp, "hosp.csv")

```

# EDA with the other hospital covariates

```{r}
# beds
ggplot(hosp, aes(x = nbeds)) + geom_histogram(bins = 35, color = "blue", fill = "skyblue1") + xlab("Hospital Beds") + ylab("Count") 

ggplot(data.frame(Beds = hosp$nbeds, Procedures = cardio_ov$`Total Procedures`), aes (x = Beds, y = Procedures)) + geom_point()

ggplot(data.frame(Beds = hosp$nbeds, Deaths = cardio_ov$`Observed Deaths`), aes (x = Beds, y = Deaths)) + geom_point()

# bassinets
ggplot(hosp[!is.na(hosp$nbassinets), ], aes(x = nbassinets)) + geom_histogram(bins = 35, color = "red", fill = "pink") + xlab("NICU Beds") + ylab("Count") 

ggplot(data.frame(Beds = hosp[!is.na(hosp$nbassinets), ]$nbeds, Procedures = cardio_ov[!is.na(hosp$nbassinets), ]$`Total Procedures`), aes (x = Beds, y = Procedures)) + geom_point() + xlab("NICU Beds")

ggplot(data.frame(Beds = hosp[!is.na(hosp$nbassinets), ]$nbeds, Deaths = cardio_ov[!is.na(hosp$nbassinets), ]$`Observed Deaths`), aes (x = Beds, y = Deaths)) + geom_point()

# cardiology rank

```


# Bayesian Hospital Compare Model (Reference Model)

```{r}
options(mc.cores = 2)
hosp_comp <- stan_glmer(cbind(deaths, procedures - deaths) ~ category + name + (1|name),
                   data = cardio_cat,
                   family = binomial(link = "logit"),
                   chains = 2,
                   iter = 1000,
                   control = list(adapt_delta = 0.85))

# saving
saveRDS(hosp_comp, "hosp_comp.rds")

# posterity
hosp_comp <- readRDS("hosp_comp.rds")
names <- rownames(summary(hosp_comp))
intercepts <- names[grepl("b[(Intercept)", names, fixed = TRUE)]
alpha <- as.matrix(hosp_comp, pars = intercepts)
alpha_cis <- posterior_interval(hosp_comp, pars = intercepts, prob = .95) # credible intervals
alpha_means <- colMeans(alpha) # posterior means

# Figure 3(b) from Paper (stratified by category)
fits <- data.frame("name" = cardio_cat$name, "category" = cardio_cat$category, "p_hat" = fitted.values(hosp_comp), "procedures" = cardio_cat$procedures)

plots <- list()
for (j in 1:5) {
  plots[[j]] <- ggplot(data = fits[fits$category == toString(j), ], aes(x = procedures, y = p_hat)) + geom_point() + labs(title = paste("Category", toString(j))) + xlab("Procedures") + ylab(TeX("$\\hat{p}$")) + theme(axis.title.y = element_text(angle = 0))
}

grid.arrange(plots[[1]], plots[[2]], plots[[3]], plots[[4]], plots[[5]], widths = c(1,1), layout_matrix = rbind(c(1,2), c(3,4), c(5,5)))

# Figure 3(b) from Paper (not stratified by category)
Phat <- fits %>% group_by(name) %>% summarize(P_hat = mean(p_hat))
Phat <- as.data.frame(Phat)
fits <- left_join(fits, Phat)

ggplot(data = fits, aes(x = procedures, y = P_hat)) + geom_point() + labs(title = TeX("$\\hat{P}$ Values Against Procedures"))

# Figure 3(a) from Paper (not stratified)
ahat <- data.frame("name" = cardio_ov$`Hospital Name`, "procedures" = cardio_ov$`Total Procedures`, "alpha_hat" = alpha_means)

ggplot(data = ahat, aes(x = procedures, y = alpha_hat)) + geom_point() + labs(title = TeX("$\\hat{\\alpha}$ Values Against Procedures"))


```


